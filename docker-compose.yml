services:
  fragments:
    init: true
    build: .
    environment:
      API_URL=http://localhost:8080
      HTPASSWD_FILE=tests/.htpasswd
      LOG_LEVEL=${LOG_LEVEL:-info}

      # Switch backend to AWS-mode
      AWS_REGION=us-east-1

      # Use LocalStack for AWS services
      AWS_S3_ENDPOINT_URL=http://localstack:4566
      AWS_DYNAMODB_ENDPOINT_URL=http://localstack:4566

      AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME:-fragments}
      AWS_DYNAMODB_TABLE_NAME=${AWS_DYNAMODB_TABLE_NAME:-fragments}

    ports:
      - "8080:8080"
    depends_on:
      - localstack

  # LocalStack (S3 + DynamoDB)
  localstack:
    image: localstack/localstack:3.5
    ports:
      - "4566:4566"
    environment:
      SERVICES=s3,dynamodb
      DEFAULT_REGION=us-east-1
      DEBUG=1
    volumes:
      # LocalStack requires Docker-in-Docker access
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "localstack_data:/var/lib/localstack"

volumes:
  localstack_data:
